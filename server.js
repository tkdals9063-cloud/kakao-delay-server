// server.js
const express = require("express");
const axios = require("axios");
const app = express();

app.use(express.json());

// ðŸ”‘ ì¹´ì¹´ì˜¤ ë´‡ í† í° (KakaoAK ...)
const KAKAO_BOT_TOKEN = "1234567890abcdef1234567890abcdef";

// 30ë¶„(1800ì´ˆ)
const DELAY = 1800 * 1000;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Sleep í•¨ìˆ˜ (ë”œë ˆì´ìš©)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// POST /delay  (ì¹´ì¹´ì˜¤ ìŠ¤í‚¬ ì„œë²„ ì—”ë“œí¬ì¸íŠ¸)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.post("/delay", async (req, res) => {
  console.log("ðŸŸ¡ ë”œë ˆì´ ìŠ¤í‚¬ ìš”ì²­ ë“¤ì–´ì˜´");

  const userKey = req.body.userRequest.user.id;
  const workType = req.body.action?.params?.workType;

  console.log("ðŸ‘‰ userKey:", userKey);
  console.log("ðŸ‘‰ workType:", workType);

  // ðŸ‘‰ ì¹´ì¹´ì˜¤ê°€ **5ì´ˆ ì•ˆì— ì‘ë‹µì„ ë°›ì•„ì•¼ í•˜ê¸° ë•Œë¬¸ì—**
  // ì¦‰ì‹œ ì„±ê³µ ì‘ë‹µì„ ë¨¼ì € ë³´ëƒ„
  res.json({
    version: "2.0",
    resultCode: "OK",
    output: {}
  });

  // âš  30ë¶„ ëŒ€ê¸°
  await sleep(DELAY);

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ê·¼ë¬´ í˜•íƒœì— ë”°ë¼ ì „ì†¡ ë©”ì‹œì§€ ë¶„ê¸°
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let message = "";

  if (workType === "sit") {
    message =
      "ðŸ’º ì˜¤ëž˜ ì•‰ì•„ê³„ì…¨ë„¤ìš”!\n\n" +
      "30ì´ˆë©´ ê°€ëŠ¥í•œ ê°„ë‹¨ ìŠ¤íŠ¸ë ˆì¹­ ì¶”ì²œë“œë¦´ê²Œìš” ðŸ˜Š\n" +
      "1) ê³ ê´€ì ˆ ì‹ ì „ ìŠ¤íŠ¸ë ˆì¹­\n" +
      "2) í‰ì¶” ì—´ê¸° ìŠ¤íŠ¸ë ˆì¹­\n" +
      "3) ëª© ì•žìª½ ëŠ˜ë ¤ì£¼ê¸°\n\n" +
      "ì§€ê¸ˆ ë°”ë¡œ í•œ ë²ˆ í•´ë³¼ê¹Œìš”?";
  } else if (workType === "stand") {
    message =
      "ðŸš¶ ì˜¤ëž˜ ì„œ ìžˆìœ¼ë©´ í•˜ì²´ê°€ ë§Žì´ ë­‰ì³ìš”!\n\n" +
      "20ì´ˆ ìŠ¤íŠ¸ë ˆì¹­ ì¶”ì²œë“œë¦½ë‹ˆë‹¤ ðŸ‘\n" +
      "1) ê³ ê´€ì ˆ êµ´ê³¡ ìŠ¤íŠ¸ë ˆì¹­\n" +
      "2) ìŠ¤íƒ ë”© í–„ìŠ¤íŠ¸ë§ ìŠ¤íŠ¸ë ˆì¹­\n" +
      "3) ë°œëª© íšŒì „ ìš´ë™";
  } else {
    message = "30ë¶„ ë™ì•ˆ ê·¼ë¬´ ì¤‘ì´ì‹œë„¤ìš”! ìŠ¤íŠ¸ë ˆì¹­ í•œë²ˆ í•´ë³´ëŠ” ê±´ ì–´ë–¨ê¹Œìš”?";
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 30ë¶„ ë’¤ ì¹´ì¹´ì˜¤ ë©”ì‹œì§€ ì „ì†¡
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  try {
    await axios({
      method: "post",
      url: "https://kapi.kakao.com/v2/bot/message/send",
      headers: {
        "Content-Type": "application/json",
        Authorization: `KakaoAK ${KAKAO_BOT_TOKEN}`
      },
      data: {
        user_key: userKey,
        template_object: {
          object_type: "text",
          text: message,
          link: { web_url: "https://kakao.com" },
          buttons: [
            {
              label: "ê·¼ë¬´ ìž¬ì‹œìž‘",
              action: "block",
              blockId: "abcd1234efgh5678ijkl9012",
              extra: { workType }
            },
            {
              label: "ê·¼ë¬´ ì¢…ë£Œ",
              action: "message",
              messageText: "ì˜¤ëŠ˜ë„ ê³ ìƒ ë§Žìœ¼ì…¨ì–´ìš”! ðŸ˜Š"
            }
          ]
        }
      }
    });

    console.log("ðŸŸ¢ 30ë¶„ ë’¤ ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ");
  } catch (err) {
    console.error("ðŸ”´ ì¹´ì¹´ì˜¤ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:", err.response?.data || err);
  }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ê¸°ë³¸ GET (ì„œë²„ ì‚´ì•„ìžˆëŠ”ì§€ ì²´í¬ìš©)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.get("/", (req, res) => {
  res.send("Server is alive");
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì„œë²„ ì‹¤í–‰
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log("ðŸš€ Server running on port", PORT);
});
